<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manuale Consensus O2-O3-AHT - Fibromialgia</title>
  <style>
    :root {
      --primary: #2c5f7c;
      --secondary: #4a9eba;
      --accent: #e74c3c;
      --bg-light: #f8f9fa;
      --bg-dark: #23272f;
      --text-dark: #222;
      --text-light: #f6f6f6;
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: var(--bg-light);
      color: var(--text-dark);
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
    }
    header {
      padding: 1.35rem 1rem 1rem 1rem;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: var(--text-light);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 10;
    }
    header .controls {
      display: flex; gap: 1rem; align-items: center;
    }
    main {
      max-width: 900px; margin: 2rem auto; padding: 1.5rem;
      background: var(--bg-light); border-radius: 10px; box-shadow: 0 2px 16px #0001;
    }
    /* Search */
    #searchBar { width: 300px; padding: 0.4rem; border-radius: 4px; border: 1px solid #c0c0c0; }
    /* Dark mode  */
    body.dark {
      background: var(--bg-dark);
      color: var(--text-light);
    }
    body.dark main { background: #282c36; box-shadow: 0 2px 16px #0004; }
    body.dark a { color: #9cf; }
    /* Quiz */
    .quiz-container { margin:2rem 0; padding:1rem; background:#d9edfa; border-radius:6px; }
    .quiz-question { font-weight:500; margin-top:1rem; }
    .quiz-feedback { margin:0.5rem 0; }
    .quiz-success { color: var(--primary); }
    .quiz-wrong { color:var(--accent);}
    /* Video */
    .video-embed { margin: 1.5rem 0; display: flex; justify-content: center; }
    .video-embed iframe { width: 560px; height: 315px; max-width: 100%; border-radius:8px; }
    /* Comments */
    .comments-section { margin: 2rem 0; border-top: 1px solid #eee; padding-top: 1rem;}
    .comments-list { margin:1rem 0; }
    .comment { margin-bottom:0.75rem; background: #f1f7fb; border-radius:4px; padding:0.5rem;}
    .comment .date { font-size:0.9em; color:#888;}
    /* Flowchart */
    #flowchart {background:#fff; padding:1rem; margin:1.5rem 0;border-radius:8px;}
    /* Print Styles */
    @media print {
      header, .controls, #searchBar, .comments-section,
      .quiz-container, #themeBtn, #languageSwitcher, #downloadPdfBtn, #downloadOriginalBtn { display: none !important; }
      main { box-shadow: none; background: #fff !important; color: #000; }
      #flowchart {background:#fff!important;}
    }
    /* Footer */
    footer {
      margin-top:2rem; padding: 1rem;
      background: var(--primary);
      color: var(--text-light);
      text-align:center;
      font-size:1rem;
      border-radius:0 0 10px 10px;
    }
  </style>
  <!-- jsPDF CDN for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Mermaid CDN for flowcharts -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
</head>
<body>
  <header>
    <div><b>Manuale O2-O3-AHT</b></div>
    <div class="controls">
      <input id="searchBar" type="text" placeholder="Cerca nel manuale..." oninput="filterManual()"/>
      <select id="languageSwitcher" onchange="switchLang()">
        <option value="it">Italiano</option>
        <option value="en">English</option>
      </select>
      <button id="themeBtn" onclick="toggleTheme()">ðŸŒ—</button>
      <button id="downloadPdfBtn" onclick="downloadPDF()">Scarica PDF</button>
      <button id="downloadOriginalBtn" onclick="downloadOriginal()">Scarica Manuale Originale</button>
    </div>
  </header>
  <main id="manual">
    <section id="manualContent">
    <h1 lang="it" class="only-it">Manuale Consensus O2-O3-AHT per Fibromialgia</h1>
    <h1 lang="en" class="only-en" style="display:none;">O2-O3-AHT Consensus Manual for Fibromyalgia</h1>
    <p lang="it" class="only-it">Manuale completo aggiornato alle ultime linee guida per la gestione della fibromialgia tramite Ossigeno Ozono Autoemoterapia...</p>
    <p lang="en" class="only-en" style="display:none;">Comprehensive updated manual on oxygen-ozone autohemotherapy for managing fibromyalgia...</p>
    <!-- Inserire qui il contenuto dettagliato in italiano/inglese -->
    </section>

    <!-- Video tutorial embed -->
    <div class="video-embed">
      <iframe src="https://www.youtube.com/embed/1DZVoN6lGHM" 
        title="Tutorial Procedurale"
        frameborder="0" allowfullscreen></iframe>
    </div>

    <!-- Flowchart interattivo -->
    <div id="flowchart">
      <pre class="mermaid" id="mermaidFlow">
        graph TD
        A[Valutazione Clinica] --> B{Criteri Diagnostici}
        B -->|Soddisfatti| C[Inizio O2-O3 AHT]
        B -->|Non Soddisfatti| D[Valutare diagnosi differenziale]
        C --> E[Monitoraggio Biomarker]
        D --> E
        E --> F{Risposta positiva?}
        F -->|SÃ¬| G[Terapia di mantenimento]
        F -->|No| H[Adattare protocollo]
      </pre>
    </div>

    <!-- Quiz interattivo -->
    <div class="quiz-container" id="quizSection">
      <div><b>Quiz di comprensione</b> / <b lang="en" style="display:none;">Comprehension Quiz</b></div>
      <div class="quiz-question" id="quizQn"></div>
      <div id="quizOptions"></div>
      <div class="quiz-feedback" id="quizFeedback"></div>
      <button onclick="nextQuiz()" id="nextQuizBtn">Domanda successiva</button>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
      <h3 lang="it" class="only-it">Lascia un feedback clinico</h3>
      <h3 lang="en" class="only-en" style="display:none;">Leave clinical feedback</h3>
      <textarea id="commentInput" style="width:100%;height:60px;border-radius:4px;"></textarea>
      <br>
      <button onclick="addComment()">Invia / Send</button>
      <div class="comments-list" id="commentsList"></div>
    </div>
  </main>
  <footer>
    Sito creato da 2M Digital Consulting srls
  </footer>
  <script>
    // PDF GENERATION
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      var doc = new jsPDF();
      doc.text(document.querySelector("#manualContent").innerText, 10, 10);
      doc.save("manuale-o2o3-fibromialgia.pdf");
    }
    // DOWNLOAD FILE ORIGINALE
    function downloadOriginal() {
      const htmlContent = document.documentElement.outerHTML;
      const blob = new Blob([htmlContent], { type: "text/html" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "manuale-originale.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    // SEARCH FUNCTIONALITY
    function filterManual() {
      var val = document.getElementById("searchBar").value.toLowerCase();
      var content = document.getElementById("manualContent");
      var html = content.innerHTML;
      if (!val) {
        [...content.children].forEach(el => {
          el.style.display = '';
        });
        return;
      }
      [...content.children].forEach(el => {
        if (el.innerText.toLowerCase().includes(val)) el.style.display = '';
        else el.style.display = 'none';
      });
    }
    // DARK MODE
    function toggleTheme() {
      document.body.classList.toggle('dark');
    }
    // LANGUAGE SWITCHER
    function switchLang() {
      var lang = document.getElementById("languageSwitcher").value;
      document.querySelectorAll('.only-it, [lang="it"]').forEach(e => e.style.display = lang === 'it' ? '' : 'none');
      document.querySelectorAll('.only-en, [lang="en"]').forEach(e => e.style.display = lang === 'en' ? '' : 'none');
      // Quiz refresh/lang
      loadQuiz();
    }
    // INTERACTIVE QUIZ LOGIC
    const quiz = [
      { qIT:"Che biomarcatori vengono monitorati in O2-O3-AHT?", opts:["IL-6, TNF-Î±, hsCRP","Bilirubina","PT, INR"], ans:0, 
        qEN:"Which biomarkers are monitored in O2-O3-AHT?", opts:["IL-6, TNF-Î±, hsCRP","Bilirubin","PT, INR"], ans:0 },
      { qIT:"Qual Ã¨ il primo step nella flowchart?", opts:["Valutazione clinica","Inizio terapia","Mantenimento"], ans:0, 
        qEN:"What is the first flowchart step?", opts:["Clinical assessment","Start therapy","Maintenance"], ans:0 },
    ];
    let quizIndex = 0;
    function loadQuiz() {
      const lang = document.getElementById("languageSwitcher").value;
      document.getElementById("quizQn").innerHTML = lang === 'it' ? quiz[quizIndex].qIT : quiz[quizIndex].qEN;
      let opts = lang === 'it' ? quiz[quizIndex].opts : quiz[quizIndex].opts;
      document.getElementById("quizOptions").innerHTML = opts.map((o,i)=>'<button onclick="checkQuiz('+i+')">'+o+'</button>').join(" ");
      document.getElementById('quizFeedback').innerHTML = "";
    }
    function checkQuiz(opt) {
      const lang = document.getElementById("languageSwitcher").value;
      if(opt === quiz[quizIndex].ans) {
        document.getElementById('quizFeedback').innerHTML = (lang=='it'?'<span class="quiz-success">Risposta corretta!</span>':'<span class="quiz-success">Correct!</span>');
      } else {
        document.getElementById('quizFeedback').innerHTML = (lang=='it'?'<span class="quiz-wrong">Risposta errata</span>':'<span class="quiz-wrong">Wrong answer</span>');
      }
    }
    function nextQuiz() {
      quizIndex = (quizIndex+1)%quiz.length;
      loadQuiz();
    }
    // VIDEO - giÃ  tutto in embed responsive

    // COMMENTS system (localStorage, solo lato client)
    function renderComments() {
      let c = JSON.parse(localStorage.getItem('comments')||'[]');
      document.getElementById('commentsList').innerHTML = c.map(o=>'<div class="comment"><div>'+o.text+'</div><div class="date">'+o.date+'</div></div>').join("");
    }
    function addComment() {
      let val = document.getElementById('commentInput').value.trim();
      if(!val) return;
      let c = JSON.parse(localStorage.getItem('comments')||'[]');
      c.unshift({text:val, date:new Date().toLocaleString()});
      localStorage.setItem('comments',JSON.stringify(c));
      document.getElementById('commentInput').value = "";
      renderComments();
    }
    // FLOWCHART
    document.addEventListener("DOMContentLoaded", function(){
      mermaid.initialize({startOnLoad:true, theme:'default'});
      renderComments();
      loadQuiz();
    });
  </script>
</body>
</html>
